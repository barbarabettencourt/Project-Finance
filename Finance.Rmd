---
title: "Finance"
author: "Barbara, Frederik, Sierra"
date: "26/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Stocks:**
Airlines:  
Lufthansa (German); DLAKY    
Scandinavian Airlines (Danish); SAS    
Southwest Airlines; LUV   
Easy Jet (British); EZJ    
RyanAir Holdings plc (British); RYAAY    
United Airlines Holdings Inc (American); UAL    
American Airlines Group Inc (American); AAL    
Spirit Airlines Inc (American); SAVE  

Beer Industry:  
Carlsberg (Danish); CABGY
Heineken (Netherlands); HEINY  
Anheuser-Busch InBev (Belgium); BUD  
Harboe (Danish); CPH: HARB-B  
Guinness from Diageo; DEO  
Molson Coors Brewing; TAP
Tsingtao Brewery Group; OTCMKTS: TSGTF
Asahi Group Holding Ltd; OTCMKTS: ASBRF

```{r include=FALSE}
library(tidyquant)
library(purrr)
library(dplyr)
library(tidyverse)
library(Hmisc)
library(reshape)
library(tseries)
library(quadprog)

options("getSymbols.warning4.0"=FALSE)
options("getSymbols.yahoo.warning"=FALSE)

tickers <- c(
              'ICEAIR',
              'DLAKY',
             'LUV',
             'EZJ',
             'RYAAY',
             'UAL',
             'AAL',
             'SAVE',
             'CABGY',
             'HEINY',
             'BUD',
             'HARB-B.CO',
             'DEO',
             'TAP',
             'TSGTF',
             'ASBRF'
)

stock_names <- c(
  'iceland',
  'luft',
  'Southwest',
  'Easy',
  'RyanAir',
  'United',
  'American',
  'Sprit',
  'Carlsberg',
  'Heineken',
  'AB',
  'Harboe',
  'Guinness',
  'Molson',
  'Tsingtao',
  'Asahi'
)

stocks <- data.frame(tickers = tickers,
                stockname = stock_names)

```

```{r}

#example for stock of Lufthansa

time <- today()-years(5)
stocks.Lufthansa <- tq_get("DLAKY", get="stock.prices", from=time)

#daily returns

daily.Lufthansa <- stocks.Lufthansa %>% 
  tq_transmute(select = adjusted, mutate_fun = periodReturn, period = "daily", col_rename = "daily_returns")

head(daily.Lufthansa)

#monthly returns

monthly.Lufthansa <- stocks.Lufthansa %>%
  tq_transmute(select = adjusted, mutate_fun = periodReturn, period = "monthly", col_rename = "monthly_returns")

head(monthly.Lufthansa)


```

```{r}

returns <- tq_get(tickers, get="stock.prices") %>%
  group_by(symbol) %>%
  tq_transmute(select=adjusted,
               mutate_fun=periodReturn,
               period="monthly",
               col_rename = "monthly_return")

returns <- returns %>% 
  pivot_wider(names_from = symbol, values_from = monthly_return)

#monthly
returns <- returns[1:131,]

```
***Part 1 ***

```{r}
#Summary
summary(returns)
hist.data.frame(returns[2:length(returns)])

for (i in 2:length(returns)){ 
  boxplot(returns[,i], ylim=c(-0.2, 0.25), main=colnames(returns)[i]) 
}

stationary_pval <- rep(0, length(returns)-1) #Adjust for date column
for (i in 2:length(returns)) { 
  stationary_pval <- kpss.test(pull(returns[,i]), null='Trend')$p.value
}

```


```{r}

returns_df <- returns[2:length(returns)]
mean_return = colMeans(returns_df,na.rm=TRUE) #Finding the mean return of each stock
covariance_mat = cov(returns_df) #Finding the covariance of the stocks
std_vector = sqrt(diag(covariance_mat)) #Finding the std. of the covariance matrix

M = length(returns_df) #The number of stocks included in this analysis, in this case 6

#Setting up environment, following the changes made at page 479
Amat = cbind(rep(1,M),mean_return,diag(1,nrow=M),-diag(1,nrow=M)) #The Constraint matrix
muP = seq(min(mean_return)+.001,max(mean_return)-.001,length=15)  #Possible means

sdP = muP  #Standard deviation for portfolio

weights = matrix(0,nrow=300,ncol=M) #The weights

for (i in 1:length(muP))
{
  #Assuring that the weights follow the requirement
  bvec = c(1,muP[i],rep(0,M),rep(0,M)) #Following the example on page 479. 
  result = solve.QP(Dmat=covariance_mat,
             dvec=rep(0,M), 
             Amat=Amat,
             bvec=bvec, 
             meq=2) #Finds the min. variance portfolio for every MuP. Creating the efficient frontier.
  
  sdP[i] = sqrt(result$value) #Saving results
  weights[i,] = result$solution  #Saving weights
}
plot(sdP,muP,type="l",xlim=c(0,2.5),ylim=c(0,0.15),lty=3) #Plotting the efficient frontier

mu_rf = 3/365 #The risk free rate
points(0,mu_rf,cex=3,col="blue",pch="*") #Showing the risk free asset
sharperatio =(muP-mu_rf)/sdP #Computing sharpe ratios
ind = (sharperatio == max(sharperatio)) #Finds the maximum sharperatio, which locates the Tangent Portfolio
lines(c(0,sdP[ind]),c(mu_rf,muP[ind]),col="red",lwd=3)  #Showing line of optimal portfolio
points(sdP[ind],muP[ind],col="red",cex=4,pch="*") #The Tangent portfolio
ind2 = (sdP == min(sdP)) #The minimum sharpe ratio is the min variance port
points(sdP[ind2],muP[ind2],col="green",cex=2,pch="*") #Plotting the min variance 
ind3 = (muP > muP[ind2]) #All portfolios with in efficient frontier
lines(sdP[ind3],muP[ind3],type="l",xlim=c(0,0.25),
      ylim=c(0,0.3),col="red",lwd=3) #Efficient frontier 

#plotting all the single stoks
text(sd_vect[1],mean_vect[1],"Stock: GM")
text(sd_vect[2],mean_vect[2],"Stock: F")
text(sd_vect[3],mean_vect[3],"Stock: UTX")
text(sd_vect[4],mean_vect[4],"Stock: CAT")
text(sd_vect[5],mean_vect[5],"Stock: MRK")
text(sd_vect[6],mean_vect[6],"Stock: IBM")


#Problem 2



```
