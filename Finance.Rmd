---
  title: "Finance"
author: "Barbara, Frederik, Sierra"
date: "26/11/2021"
output: pdf_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Stocks:**
  Airlines:  
  Lufthansa (German); DLAKY    
Southwest Airlines; LUV   
Easy Jet (British); EZJ    
RyanAir Holdings plc (British); RYAAY    
United Airlines Holdings Inc (American); UAL    
American Airlines Group Inc (American); AAL    
Spirit Airlines Inc (American); SAVE  

Beer Industry:  
  Carlsberg (Danish); CABGY
Heineken (Netherlands); HEINY  
Anheuser-Busch InBev (Belgium); BUD  
Harboe (Danish); CPH: HARB-B  
Guinness from Diageo; DEO  
Molson Coors Brewing; TAP
Tsingtao Brewery Group; OTCMKTS: TSGTF
Asahi Group Holding Ltd; OTCMKTS: ASBRF

**Descriptive Analysis**

```{r include=FALSE}

library(tidyquant)
library(purrr)
library(dplyr)
library(tidyverse)
library(Hmisc)
library(reshape)
library(tseries)
library(quadprog)
library(DescTools)
library(ggplot2)
library(reshape2)
library(car)
library(tseries)
library(gridExtra)
library(RCurl)
library(readr)
library(QRM)
library("Ecdat")
library("fGarch")
library(copula)


```


```{r include=FALSE}

options("getSymbols.warning4.0"=FALSE)
options("getSymbols.yahoo.warning"=FALSE)

tickers <- c(
  'DLAKY',
  'LUV',
  'EZJ',
  'RYAAY',
  'UAL',
  'AAL',
  'SAVE',
  'CABGY',
  'HEINY',
  'BUD',
  'HARB-B.CO',
  'DEO',
  'TAP',
  'TSGTF',
  'ASBRF',
  'IVV'
)

stock_names <- c(
  'Lufthansa',
  'Southwest',
  'EasyJet',
  'RyanAir',
  'United',
  'American',
  'Spirit',
  'Carlsberg',
  'Heineken',
  'AB',
  'Harboe',
  'Guinness',
  'Molson',
  'Tsingtao',
  'Asahi',
  'SP500'
)

stocks <- data.frame(tickers = tickers,
                     stockname = stock_names)

```

```{r}

returns <- tq_get(tickers, get="stock.prices") %>%
  group_by(symbol) %>%
  tq_transmute(select=adjusted,
               mutate_fun=periodReturn,
               period="monthly",
               col_rename = "monthly_return")

returns <- returns %>% 
  pivot_wider(names_from = symbol, values_from = monthly_return)

#monthly returns
returns <- returns[1:131,]

```

***Part 1***
  1. Table of mean, sd, skewness, kurtosis and beta.   

```{r}

returns <- as.data.frame(returns)
returnsNA <- as.data.frame(na.omit(returns))
returnsIVV <- returns[1:16]

# columns of table
Stocks <- stock_names[1:15]
Means <- rep(NA, 15)
Sd <- rep(NA,15)
Skewness <- rep(NA,15)
Kurtosis <- rep(NA,15)
table <- data.frame(Stocks,Means,Sd,Skewness,Kurtosis)


# means

for(i in 1:15)
{
  table$Means[i] <- mean(returnsNA[,i+1])
}

# sd

for(i in 1:15)
{
  table$Sd[i] <- sd(returnsNA[,i+1])
}

# skewness should be around 0 to be normally distributed

for(i in 1:15)
{
  table$Skewness[i] <- Skew(returnsNA[,i+1])
}

# kurtosis should be around 3 to be normally distributed

for(i in 1:15)
{
  table$Kurtosis[i] <- Kurt(returnsNA[,i+1])
}

# betas 
#cAPM model, risk free and market portfolio IVV
table
```

2. Plot each set of returns  

```{r}
returns <- as.data.frame(returns)

for (i in 1:15)
{
  names <- list(stock_names)
  print(ggplot(returns, aes(x=date, y=returns[,i+1])) +
          geom_line(color="steelblue") + 
          geom_point() +
          xlab("") +
          ylab(names[[1]][i])+
          ggtitle("Plot of Returns") + 
          theme(plot.title = element_text(hjust = 0.5))) 
}

#united airlines and american airlines

airlines <- returns %>%
  select(date, UAL, AAL) %>%
  gather(key="Stocks", value = "Returns", -date)

ggplot(airlines, aes(x = date, y = Returns)) + 
  geom_line(aes(color = Stocks)) + 
  scale_color_manual(values = c("skyblue4", "orchid1")) +
  geom_hline(yintercept=0,linetype="dashed", alpha=0.5)+
  geom_vline(xintercept = as.Date("2020-01-31"), linetype="dashed", alpha=0.5) +
  ggtitle("Returns of United and American Airlines") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("")

rm(airlines)

#carslberg and asahi

beers <- returns %>%
  select(date, CABGY, ASBRF ) %>%
  gather(key="Stocks", value = "Returns", -date)

ggplot(beers, aes(x = date, y = Returns)) + 
  geom_line(aes(color = Stocks)) + 
  scale_color_manual(values = c("skyblue4", "orchid1")) +
  geom_hline(yintercept=0,linetype="dashed", alpha=0.5)+
  geom_vline(xintercept = as.Date("2020-01-31"), linetype="dashed", alpha=0.5) +
  ggtitle("Returns of Carlsberg and Asahi") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("")


rm(beers)
```
3. Plot equity curve  
https://bookdown.org/compfinezbook/introcompfinr/ReturnCalculationsR.html#

```{r}

returnsNA <- as.data.frame(na.omit(returns))   #doesn't work with NA values

equityCurve <- as.data.frame(matrix(c(rep(NA,113*15)), nrow= 113)) 
for (i in 1:15) 
{  
  equityCurve[,i] <- cumprod(1 + returnsNA[,i+1]) 
}


equityCurve <- cbind(returnsNA[,1], equityCurve)
colnames(equityCurve)[1] <- "date"

#airlines 7
for (i in 1:7)
{
  names <- list(stock_names)
  print(ggplot(equityCurve, aes(x=date, y=equityCurve[,i+1])) +
          ggtitle("Equity Curve") +
          theme(plot.title = element_text(hjust = 0.5))+  
          geom_line(color="steelblue") + 
          xlab("") +
          ylab(names[[1]][i]))  
}

#beers
for (i in 1:8)
{
  names <- list(stock_names)
  print(ggplot(equityCurve, aes(x=date, y=equityCurve[,i+7])) +
          ggtitle("Equity Curve") + 
          theme(plot.title = element_text(hjust = 0.5)) +  
          geom_line(color="steelblue") + 
          xlab("") +
          ylab(names[[1]][i+7]))  
}

```
You should also provide an equity curve for each asset (that is, a
                                                        curve that shows the growth of a $1 in each of the asset over the time period you chose)
and comment of your results. You should do the same for S&P 500 and compare it with the
assets.

```{r}

equityCurveSP <- cumprod(1 + returnsNA[,17])

namesair <- names[[1]][1:7]
namesair <- append(namesair, "SP500")

colors <- c(1,2,3,4,5,6,7,1)
lt <- c(1,1,1,1,1,1,1,2)

#airlines
plot(equityCurve[,1], equityCurve[,2], type = "l", ylim= c(0.2,6), xlab="", ylab="Airlines", main="Equity Curves of Airlines")
for(i in 1:6)
{
  lines(equityCurve[,1], equityCurve[,i+2], type = "l", col = i+1)
}
lines(equityCurve[,1],equityCurveSP,type="l", lty=2, lwd=1, col="black")
abline(v=as.Date("2020-01-31"), lty=2, col="dimgrey")
legend(x='topleft', legend=namesair,col=colors, lty=lt, cex=0.8)

####################################################################

colors <- c(1,2,3,4,5,6,7,8,1)
lt <- c(1,1,1,1,1,1,1,1,2)

#beers
plot(equityCurve[,1], equityCurve[,9], type = "l", ylim= c(0.4,4), xlab="", ylab="Beers", main="Equity Curves of Beers")
for(i in 1:7)
{
  lines(equityCurve[,1], equityCurve[,i+9], type = "l", col = i+1)
}
lines(equityCurve[,1],equityCurveSP,type="l", lty=2, lwd=1, col="black")
abline(v=as.Date("2020-01-31"), lty=2, col="dimgrey")
legend(x='topleft', legend=names[[1]][8:16],col=colors, lty=lt, cex=0.8)

```


4. Histograms for each return series  

```{r}

for (i in 1:15)
{
  names <- list(stock_names)
  print(ggplot(returnsNA, aes(x=returnsNA[,i+1])) +
          geom_histogram(aes(y=..density..), colour="black", fill="white") + 
          geom_density(alpha=.2, fill="#FF6666")+ 
          xlab("") +
          ggtitle(names[[1]][i])+
          theme(plot.title = element_text(hjust = 0.5)))  
}


```
5. Boxplots for each return series  

```{r}

#individual boxplots

for (i in 1:15)
{
  names <- list(stock_names)
  boxplot(returnsIVV[,i+1], xlab="", main = names[[1]][i])
}


returnsbox <- returnsNA
colnames(returnsbox)[2:16] <- names[[1]]
colors <- c('cadetblue1', 'coral', 'darkolivegreen1', 'lightgoldenrod1')

#airlines
boxplot(returnsbox[,2:8], col = colors, main= "Boxplots of Airlines")

#beers
boxplot(returnsbox[,9:16], col= colors, main = "Boxplots of Beers")

```

6. qqplots for each return series  

```{r}

for (i in 1:15)
{
  qqPlot(returnsNA[,i+1], main = names[[1]][i])
}


```

7. Run tests for stationarity  

```{r}
#null hypothesis is series is non stationary

for (i in 1:15)
{
  print(adf.test(returnsNA[,i+1]))
}

#all pvalues are less than 0.01 and so p-value<0.05 hence we reject the null hypothesis and conclude that there is enough evidence to conclude that the returns are stationary

#graphically we can see that all the returns have no trends and the oscillations between the returns seem to be at a constant width, so constant deviation. All pointing towards stationarity.

```

8. Check if returns are normally distributed

```{r}

#From the histograms the returns appear to have the normal distribution shape, where most of them appear unimodal. There appears to be a few that are skewed, which can also be observed in the boxplots.
#Looking at the qqplots we can see a few of the returns have values outside the interval which means they are not normally distributed. 
#lastly we do the Shapiro test
#null hypothesis: normal 

for (i in 1:15)
{
  print(shapiro.test(returnsNA[,i+1]))
}

#normal <- 1,2,3,4,9,10,12,14,8 barely with 0.05991
#not normal <- 5,6,7,11,13,15

```

9. Fit different distributions to your data, which one fits better?
  
```{r}

#t distribution

AIC_t <- c(rep(NA), 15)
BIC_t <- c(rep(NA), 15)

for (i in 1:15) 
{
  x <- diff(returnsNA[,i+1])
  n = length(x)
  start = c(mean(x), sd(x), 5)
  loglik_t = function(beta) sum( - dt((x - beta[1]) / beta[2], beta[3], log = TRUE) + log(beta[2]) )
  fit_t = optim(start, loglik_t, hessian = T, method = "L-BFGS-B", lower = c(-1, 0.001, 1))
  AIC_t[i] = 2 * fit_t$value + 2 * 3
  BIC_t[i] = 2 * fit_t$value + log(n) * 3  
}

#skewed student t
#not work: Harboe=11 

AIC_sstd <- c(rep(NA), 15)
BIC_sstd <- c(rep(NA), 15)

for (i in 1:10)
{  
  x <- diff(returnsNA[,i+1])
  n = length(x)
  loglik_sstd = function(beta) sum(- dsstd(x, mean = beta[1], sd = beta[2], nu = beta[3], xi = beta[4], log = TRUE))
  start = c(mean(x), sd(x), 5, 1)
  fit_sstd = optim(start, loglik_sstd, hessian = T, method = "L-BFGS-B", lower = c(-0.1, 0.01, 2.1, -2))
  AIC_sstd[i] = 2*fit_sstd$value + 2 * 4
  BIC_sstd[i]= 2*fit_sstd$value + log(n) * 4
}

for (i in 1:4)
{  
  x <- diff(returnsNA[,i+12])
  n = length(x)
  loglik_sstd = function(beta) sum(- dsstd(x, mean = beta[1], sd = beta[2], nu = beta[3], xi = beta[4], log = TRUE))
  start = c(mean(x), sd(x), 5, 1)
  fit_sstd = optim(start, loglik_sstd, hessian = T, method = "L-BFGS-B", lower = c(-0.1, 0.01, 2.1, -2))
  AIC_sstd[i+11] = 2*fit_sstd$value + 2 * 4
  BIC_sstd[i+11]= 2*fit_sstd$value + log(n) * 4
}

#ged 

AIC_ged <- c(rep(NA), 15)
BIC_ged <- c(rep(NA), 15)

for (i in 1:15)
{
  x <- diff(returnsNA[,i+1])
  n = length(x)
  loglik_ged = function(beta) sum( - dged(x,mean=beta[1],sd=beta[2],nu=beta[3],log=TRUE) )
  start = c(mean(x),sd(x),1)
  fit_ged = optim(start,loglik_ged,hessian=T,method="L-BFGS-B",lower = c(-.1,.01,1))
  AIC_ged[i] = 2*fit_ged$value+2*4
  BIC_ged[i] = 2*fit_ged$value+log(n)*4
}

#normal 
AIC_n <- c(rep(NA), 15)
BIC_n <- c(rep(NA), 15)

for (i in 1:15)
{
  x <- diff(returnsNA[,i+1])
  n = length(x)
  start = c(mean(x),sd(x),1)
  loglik_n = function(beta) sum( - dnorm(x,mean=beta[1],sd=beta[2],log=TRUE) )
  fit_n = optim(start, loglik_n, hessian = T,
                method = "L-BFGS-B", lower = c(-1, 0.001, 1))
  AIC_n[i] = 2 * fit_n$value + 2 * 3
  BIC_n[i] = 2 * fit_n$value + log(n) * 3
}

########################

table <- data.frame(AIC_t,AIC_sstd,AIC_ged,AIC_n,BIC_t,BIC_sstd,BIC_ged,BIC_n)
table <- cbind(Stocks, table)
table

AIC_result <- c("Skewed Sd t", "t Dist", "Ged", "Skewed Sd t", "t Dist", "t Dist", "t Dist", "Skewed Sd t", "t Dist", "t Dist", "Normal", "Skewed Sd t", "Skewed Sd t", "Normal", "t Dist")
BIC_result <- c("t Dist","t Dist","t Dist","t Dist","t Dist","t Dist","t Dist","t Dist","t Dist","t Dist","Normal","t Dist","t Dist","Normal","t Dist")

table <- cbind(table, AIC_result, BIC_result)
colnames(table)[2:11] <- c("t AIC", "Skewed t AIC", "Ged AIC", "Normal AIC", "t BIC", "Skewed t BIC", "Ged BIC", "Normal BIC", "Best AIC", "Best BIC")
table
```

10.  Compute Sharpe’s slope for each asset. Which asset has the highest slope?
  If E(RP) and $\sigma_{R_p}$ are the expected return and standard deviation of the
return on a portfolio and $\mu_f$ is the risk-free rate, then
Sharpe's slope = $\frac{(E(R_P)-\mu_f)}{\sigma_{Rp}}$

```{r}
riskfree <- 0.04

SharpesSlope <- rep(NA,15)

for (i in 1:15) 
{
  SharpesSlope[i] <- (mean(returnsNA[,i+1]) - riskfree)/sd(returnsNA[,i+1])
}

#If the analysis results in a negative Sharpe ratio, it either means the risk-free rate is greater than the portfolio's return, or the portfolio's return is expected to be negative. In either case, a negative Sharpe ratio does not convey any useful meaning.

SharpesSlope
max(SharpesSlope) #highest slope

```

11. Convert the monthly sample means into annual estimates by multiplying by 12 and convert the monthly sample SDs into annual estimates by multiplying by the square root of 12. Comment on the values of these annual
numbers.

```{r}
#?

#annualsamplemeans <- returns[,2:16] *12


#annualsamplesd <- sd(returns[,2:16])*sqrt(12)



```

12. Construct pairwise scatter plots between your assets returns and comment on
any relationships you see.

```{r}
#airlines
pairs(returns[,2:8], main="Scatterplot of Airline Returns")

#beers
pairs(returns[,9:16], main="Scatterplot of Beer Returns")
```

13. You should also compute the sample covariance matrix of the
returns on your assets and comment on the direction of linear association between the asset
returns.

```{r}

# covariance monthly data

Covariances <- as.data.frame(cov(returnsNA[2:16]))

#they all have positive covariances hence the returns all move together, vary in the same direction.

Covariancesair <- Covariances[1:7,1:7]
Covariancesbeers <- Covariances[8:15,8:15]

# covariance annualized data

annualreturns <- returnsNA[,2:16]*12

Covariancesannual <- as.data.frame(cov(annualreturns[1:15]))

#they all have positive covariances hence the returns all move together, vary in the same direction.

Covariancesairannual <- Covariancesannual[1:7,1:7]
Covariancesbeersannual <- Covariancesannual[8:15,8:15]


#########################
#correlation for monthly data

Correlations <- as.data.frame(cor(returnsNA[2:16]))

#they all have positive covariances hence the returns all move together, vary in the same direction.

Correlationsair <- Correlations[1:7,1:7]
Correlationsbeers <- Correlations[8:15,8:15]


```


**PCA**

```{r}
library(ggfortify)

#all stocks

pca = prcomp(returnsNA[,2:16], scale = TRUE)

#pc1 and pc2
autoplot(pca, data=returnsNA[,2:16], loadings=TRUE, loadings.label=TRUE) + ggtitle("1st and 2nd Principal Components of the 15 stocks") + theme(plot.title = element_text(hjust = 0.5))

#pc2 and pc3
autoplot(pca, data=returnsNA[,2:16], loadings=TRUE, loadings.label=TRUE, x=2, y=3) + ggtitle("2nd and 3rd Principal Components of the 15 stocks") + theme(plot.title = element_text(hjust = 0.5))

summary(pca)

#airlines

pca = prcomp(returnsNA[,2:8], scale = TRUE)

#pc1 and pc2
autoplot(pca, data=returnsNA[,2:8], loadings=TRUE, loadings.label=TRUE)+ ggtitle("1st and 2nd Principal Components of the Airline stocks") + theme(plot.title = element_text(hjust = 0.5))

#pc2 and pc3
autoplot(pca, data=returnsNA[,2:8], loadings=TRUE, loadings.label=TRUE, x=2, y=3)+ ggtitle("2nd and 3rd Principal Components of the Airline stocks") + theme(plot.title = element_text(hjust = 0.5))

summary(pca)

#beers

pca = prcomp(returnsNA[,9:16], scale = TRUE)

#pc1 and pc2
autoplot(pca, data=returnsNA[,9:16], loadings=TRUE, loadings.label=TRUE)+ ggtitle("1st and 2nd Principal Components of the Beer stocks") + theme(plot.title = element_text(hjust = 0.5))

#pc2 and pc3
autoplot(pca, data=returnsNA[,9:16], loadings=TRUE, loadings.label=TRUE, x=2, y=3)+ggtitle("2nd and 3rd Principal Components of the Beer stocks") + theme(plot.title = element_text(hjust = 0.5))

summary(pca)
```
**Factor Models**

```{r}

fit <- factanal(x=returnsNA[2:16], factors = 2)
fit

#loadings are betahat transpose
#uniquenesses: the diagonal elements of the estimate bigsigma.hat_epsilon
```



```{r eval=FALSE, include=FALSE}

returns_df <- returns[2:length(returns)]
mean_return = colMeans(returns_df,na.rm=TRUE) #Finding the mean return of each stock
covariance_mat = cov(returns_df) #Finding the covariance of the stocks
std_vector = sqrt(diag(covariance_mat)) #Finding the std. of the covariance matrix

M = length(returns_df) #The number of stocks included in this analysis, in this case 6

#Setting up environment, following the changes made at page 479
Amat = cbind(rep(1,M),mean_return,diag(1,nrow=M),-diag(1,nrow=M)) #The Constraint matrix
muP = seq(min(mean_return)+.001,max(mean_return)-.001,length=15)  #Possible means

sdP = muP  #Standard deviation for portfolio

weights = matrix(0,nrow=300,ncol=M) #The weights

for (i in 1:length(muP))
{
  #Assuring that the weights follow the requirement
  bvec = c(1,muP[i],rep(0,M),rep(0,M)) #Following the example on page 479. 
  result = solve.QP(Dmat=covariance_mat,
             dvec=rep(0,M), 
             Amat=Amat,
             bvec=bvec, 
             meq=2) #Finds the min. variance portfolio for every MuP. Creating the efficient frontier.
  
  sdP[i] = sqrt(result$value) #Saving results
  weights[i,] = result$solution  #Saving weights
}
plot(sdP,muP,type="l",xlim=c(0,2.5),ylim=c(0,0.15),lty=3) #Plotting the efficient frontier

mu_rf = 3/365 #The risk free rate
points(0,mu_rf,cex=3,col="blue",pch="*") #Showing the risk free asset
sharperatio =(muP-mu_rf)/sdP #Computing sharpe ratios
ind = (sharperatio == max(sharperatio)) #Finds the maximum sharperatio, which locates the Tangent Portfolio
lines(c(0,sdP[ind]),c(mu_rf,muP[ind]),col="red",lwd=3)  #Showing line of optimal portfolio
points(sdP[ind],muP[ind],col="red",cex=4,pch="*") #The Tangent portfolio
ind2 = (sdP == min(sdP)) #The minimum sharpe ratio is the min variance port
points(sdP[ind2],muP[ind2],col="green",cex=2,pch="*") #Plotting the min variance 
ind3 = (muP > muP[ind2]) #All portfolios with in efficient frontier
lines(sdP[ind3],muP[ind3],type="l",xlim=c(0,0.25),
      ylim=c(0,0.3),col="red",lwd=3) #Efficient frontier 

#plotting all the single stoks
text(sd_vect[1],mean_vect[1],"Stock: GM")
text(sd_vect[2],mean_vect[2],"Stock: F")
text(sd_vect[3],mean_vect[3],"Stock: UTX")
text(sd_vect[4],mean_vect[4],"Stock: CAT")
text(sd_vect[5],mean_vect[5],"Stock: MRK")
text(sd_vect[6],mean_vect[6],"Stock: IBM")


#Problem 2



```
