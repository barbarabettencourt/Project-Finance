---
title: "Finance"
author: "Barbara, Frederik, Sierra"
date: "26/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

**Stocks:**
Airlines:  
Lufthansa (German); DLAKY    
Southwest Airlines; LUV   
Easy Jet (British); EZJ    
RyanAir Holdings plc (British); RYAAY    
United Airlines Holdings Inc (American); UAL    
American Airlines Group Inc (American); AAL    
Spirit Airlines Inc (American); SAVE  

Beer Industry:  
Carlsberg (Danish); CABGY
Heineken (Netherlands); HEINY  
Anheuser-Busch InBev (Belgium); BUD  
Harboe (Danish); CPH: HARB-B  
Guinness from Diageo; DEO  
Molson Coors Brewing; TAP
Tsingtao Brewery Group; OTCMKTS: TSGTF
Asahi Group Holding Ltd; OTCMKTS: ASBRF

```{r include=FALSE}

library(tidyquant)
library(purrr)
library(dplyr)
library(tidyverse)
library(Hmisc)
library(reshape)
library(tseries)
library(quadprog)
library(DescTools)
library(ggplot2)
library(reshape2)
library(car)
library(tseries)
library(gridExtra)
library(RCurl)
library(readr)

```


```{r include=FALSE}

options("getSymbols.warning4.0"=FALSE)
options("getSymbols.yahoo.warning"=FALSE)

tickers <- c(
              'DLAKY',
             'LUV',
             'EZJ',
             'RYAAY',
             'UAL',
             'AAL',
             'SAVE',
             'CABGY',
             'HEINY',
             'BUD',
             'HARB-B.CO',
             'DEO',
             'TAP',
             'TSGTF',
             'ASBRF'
)

stock_names <- c(
  'Lufthansa',
  'Southwest',
  'EasyJet',
  'RyanAir',
  'United',
  'American',
  'Spirit',
  'Carlsberg',
  'Heineken',
  'AB',
  'Harboe',
  'Guinness',
  'Molson',
  'Tsingtao',
  'Asahi'
)

stocks <- data.frame(tickers = tickers,
                stockname = stock_names)

```

```{r}

returns <- tq_get(tickers, get="stock.prices") %>%
  group_by(symbol) %>%
  tq_transmute(select=adjusted,
               mutate_fun=periodReturn,
               period="monthly",
               col_rename = "monthly_return")

returns <- returns %>% 
  pivot_wider(names_from = symbol, values_from = monthly_return)

#monthly
returns <- returns[1:131,]

```

***Part 1***
1. Table of mean, sd, skewness, kurtosis and beta.   

```{r}
# columns

returns <- as.data.frame(returns)
Stocks <- stock_names
Means <- rep(NA, 15)
Sd <- rep(NA,15)
Skewness <- rep(NA,15)
Kurtosis <- rep(NA,15)
table <- data.frame(Stocks,Means,Sd,Skewness,Kurtosis)

# means

for(i in 2:16)
  {
    table$Means[i-1] <- mean(na.omit(returns[,i]))
  }

# sd

for(i in 2:16)
  {
    table$Sd[i-1] <- sd(na.omit(returns[,i]))
  }

# skewness should be around 0 to be normally distributed

for(i in 2:16)
  {
    table$Skewness[i-1] <- Skew(na.omit(returns[,i]))
  }

# kurtosis should be around 3 to be normally distributed

for(i in 2:16)
  {
    table$Kurtosis[i-1] <- Kurt(na.omit(returns[,i]))
  }

# betas 

table
```

2. Plot each set of returns  

```{r}
returns <- as.data.frame(returns)

for (i in 1:15)
{
  names <- list(stock_names)
  print(ggplot(returns, aes(x=date, y=returns[,i+1])) +
  geom_line(color="steelblue") + 
  geom_point() +
  xlab("") +
  ylab(names[[1]][i])+
  ggtitle("Plot of Returns") + 
  theme(plot.title = element_text(hjust = 0.5))) 
}

#united airlines american airlines

airlines <- returns %>%
            select(date, UAL, AAL) %>%
            gather(key="Stocks", value = "Returns", -date)
  
ggplot(airlines, aes(x = date, y = Returns)) + 
  geom_line(aes(color = Stocks)) + 
  scale_color_manual(values = c("skyblue4", "orchid1")) +
  geom_hline(yintercept=0,linetype="dashed", alpha=0.5)+
  geom_vline(xintercept = as.Date("2020-01-31"), linetype="dashed", alpha=0.5) +
  ggtitle("Returns of United and American Airlines") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("")

rm(airlines)

#carslberg, asahi

beers <- returns %>%
         select(date, CABGY, ASBRF ) %>%
         gather(key="Stocks", value = "Returns", -date)

ggplot(beers, aes(x = date, y = Returns)) + 
  geom_line(aes(color = Stocks)) + 
  scale_color_manual(values = c("skyblue4", "orchid1")) +
  geom_hline(yintercept=0,linetype="dashed", alpha=0.5)+
  geom_vline(xintercept = as.Date("2020-01-31"), linetype="dashed", alpha=0.5) +
  ggtitle("Returns of Carlsberg and Asahi") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("")


rm(beers)
```
3. Plot equity curve  
https://bookdown.org/compfinezbook/introcompfinr/ReturnCalculationsR.html#

```{r}

returnsNA <- as.data.frame(na.omit(returns))   #doesn't work with NA values

equityCurve <- as.data.frame(matrix(c(rep(NA,113*15)), nrow= 113)) 
for (i in 1:15) 
{  
  equityCurve[,i] <- cumprod(1 + returnsNA[,i+1]) 
}


equityCurve <- cbind(returnsNA[,1], equityCurve)
colnames(equityCurve)[1] <- "date"

#airlines 7
for (i in 1:7)
{
  names <- list(stock_names)
  print(ggplot(equityCurve, aes(x=date, y=equityCurve[,i+1])) +
  ggtitle("Equity Curve") +
  theme(plot.title = element_text(hjust = 0.5))+  
  geom_line(color="steelblue") + 
  xlab("") +
  ylab(names[[1]][i]))  
}

#beers
for (i in 1:8)
{
  names <- list(stock_names)
  print(ggplot(equityCurve, aes(x=date, y=equityCurve[,i+7])) +
  ggtitle("Equity Curve") + 
  theme(plot.title = element_text(hjust = 0.5)) +  
  geom_line(color="steelblue") + 
  xlab("") +
  ylab(names[[1]][i+7]))  
}

#need to add legends

#airlines
plot(equityCurve[,1], equityCurve[,2], type = "l", ylim= c(0.2,6), xlab="", ylab="Airlines", main="Equity Curves of Airlines")
for(i in 1:6)
{
  lines(equityCurve[,1], equityCurve[,i+2], type = "l", col = i+1)
}
abline(v=as.Date("2020-01-31"), lty=2, col="dimgrey")
legend(x='topleft', legend=names[[1]][1:7],col=1:7, lty=1, cex=0.8)


#beers
plot(equityCurve[,1], equityCurve[,9], type = "l", ylim= c(0.4,3), xlab="", ylab="Beers", main="Equity Curves of Beers")
for(i in 1:7)
{
  lines(equityCurve[,1], equityCurve[,i+9], type = "l", col = i+1)
}
abline(v=as.Date("2020-01-31"), lty=2, col="dimgrey")
legend(x='topleft', legend=names[[1]][8:15],col=1:7, lty=1, cex=0.8)


```
You should also provide an equity curve for each asset (that is, a
curve that shows the growth of a $1 in each of the asset over the time period you chose)
and comment of your results. You should do the same for S&P 500 and compare it with the
assets.

```{r include=FALSE}
SP500 <- read_csv("data/SP500.csv")
```

```{r}

#Sp500 has 500 stocks? so do we chose random ones?
#The dataset has 2783 values but with no dates so cant really compare

```


4. Histograms for each return series  

```{r}

for (i in 1:15)
{
  names <- list(stock_names)
  print(ggplot(returnsNA, aes(x=returnsNA[,i+1])) +
  geom_histogram(aes(y=..density..), colour="black", fill="white") + 
  geom_density(alpha=.2, fill="#FF6666")+ 
  xlab("") +
  ggtitle(names[[1]][i])+
  theme(plot.title = element_text(hjust = 0.5)))  
}


```
5. Boxplots for each return series  

```{r}

#individual boxplots

for (i in 1:15)
{
  names <- list(stock_names)
  boxplot(returns[,i+1], xlab="", main = names[[1]][i])
}


returnsbox <- returns
colnames(returnsbox)[2:16] <- names[[1]]
colors <- c('cadetblue1', 'coral', 'darkolivegreen1', 'lightgoldenrod1')

#airlines
boxplot(returnsbox[,2:8], col = colors, main= "Boxplots of Airlines")

#beers
boxplot(returnsbox[,8:16], col= colors, main = "Boxplots of Beers")

```

6. qqplots for each return series  

```{r}

for (i in 1:15)
{
  qqPlot(returns[,i+1], main = names[[1]][i])
}


```

7. Run tests for stationarity  

```{r}
#null hypothesis is series is non stationary

for (i in 1:15)
{
 print(adf.test(returnsNA[,i+1]))
}

#all pvalues are less than 0.01 and so p-value<0.05 hence we reject the null hypothesis and conclude that there is enough evidence to conclude that the returns are stationary

#graphically we can see that all the returns have no trends and the oscillations between the returns seem to be at a constant width, so constant deviation. All pointing towards stationarity.

```

8. Check if returns are normally distributed

```{r}

#From the histograms the returns appear to have the normal distribution shape, where most of them appear unimodal. There appears to be a few that are skewed, which can also be observed in the boxplots.
#Looking at the qqplots we can see a few of the returns have values outside the interval which means they are not normally distributed. 
#lastly we do the Shapiro test
#null hypothesis: normal 

for (i in 1:15)
{
 print(shapiro.test(returnsNA[,i+1]))
}

#normal <- 1,2,3,4,9,10,12,14,8 barely with 0.05991
#not normal <- 5,6,7,11,13,15

```

9. Fit different distributions to your data, which one fits better?

```{r}



```

10.  Compute Sharpeâ€™s slope for each asset. Which asset has the highest slope?
If E(RP) and $\sigma_{R_p}$ are the expected return and standard deviation of the
return on a portfolio and $\mu_f$ is the risk-free rate, then
Sharpe's slope = $\frac{(E(R_P)-\mu_f)}{\sigma_{Rp}}$

```{r}

```

11. Convert the monthly sample means into annual estimates by multiplying by 12 and convert the monthly sample SDs into annual estimates by multiplying by the square root of 12. Comment on the values of these annual
numbers.

```{r}

annualsamplemeans <- returns[,2:16] *12


```

12. Construct pairwise scatter plots between your assets returns and comment on
any relationships you see.

```{r}
#dont need this as we've already plotted the returns before?
```

13. You should also compute the sample covariance matrix of the
returns on your assets and comment on the direction of linear association between the asset
returns.

```{r}

#airplanes 7 
covmatrixair <- matrix(rep(NA,7*7),nrow=7)

for (i in 1:7)
{
  for (j in 1:7) 
    {
      covmatrixair[i,j] <- cov(returnsNA[,i+1], returnsNA[,j+1])
    }
}  

# beers 8
covmatrixbeers <- matrix(rep(NA,8*8),nrow=8)

for (i in 1:8)
{
  for (j in 1:8) 
    {
      covmatrixbeers[i,j] <- cov(returnsNA[,i+8], returnsNA[,j+8])
    }
}

#they all have positive covariances hence the returns all move together, vary in the same direction.

#lets pick 3 airplanes and 3 beers and check their coavriances

covmatrixmix <- matrix(rep(NA,6*6), nrow=6)

for (i in 1:6)
{
  for (j in 1:6) 
    {
      if (i<=3 & j<=3)
      {
        covmatrixmix[i,j] <- cov(returnsNA[,i+1], returnsNA[,j+1])
      }
      else if (i>3 & j>3)
      {
        covmatrixmix[i,j] <- cov(returnsNA[,i+8], returnsNA[,j+8])
      }
    }
}

for (i in 1:3)
{
  for (j in 1:3)
    {
      covmatrixmix[i+3,j] <- cov(returnsNA[,i+1], returnsNA[,j+8])
    }
}

for (i in 1:3)
{
  for (j in 1:3)
    {
      covmatrixmix[i,j+3] <- cov(returnsNA[,i+1], returnsNA[,j+8])
    }
}

# need to double check code but if its right the covariances are all positive

```


```{r}

returns_df <- returns[2:length(returns)]
mean_return = colMeans(returns_df,na.rm=TRUE) #Finding the mean return of each stock
covariance_mat = cov(returns_df) #Finding the covariance of the stocks
std_vector = sqrt(diag(covariance_mat)) #Finding the std. of the covariance matrix

M = length(returns_df) #The number of stocks included in this analysis, in this case 6

#Setting up environment, following the changes made at page 479
Amat = cbind(rep(1,M),mean_return,diag(1,nrow=M),-diag(1,nrow=M)) #The Constraint matrix
muP = seq(min(mean_return)+.001,max(mean_return)-.001,length=15)  #Possible means

sdP = muP  #Standard deviation for portfolio

weights = matrix(0,nrow=300,ncol=M) #The weights

for (i in 1:length(muP))
{
  #Assuring that the weights follow the requirement
  bvec = c(1,muP[i],rep(0,M),rep(0,M)) #Following the example on page 479. 
  result = solve.QP(Dmat=covariance_mat,
             dvec=rep(0,M), 
             Amat=Amat,
             bvec=bvec, 
             meq=2) #Finds the min. variance portfolio for every MuP. Creating the efficient frontier.
  
  sdP[i] = sqrt(result$value) #Saving results
  weights[i,] = result$solution  #Saving weights
}
plot(sdP,muP,type="l",xlim=c(0,2.5),ylim=c(0,0.15),lty=3) #Plotting the efficient frontier

mu_rf = 3/365 #The risk free rate
points(0,mu_rf,cex=3,col="blue",pch="*") #Showing the risk free asset
sharperatio =(muP-mu_rf)/sdP #Computing sharpe ratios
ind = (sharperatio == max(sharperatio)) #Finds the maximum sharperatio, which locates the Tangent Portfolio
lines(c(0,sdP[ind]),c(mu_rf,muP[ind]),col="red",lwd=3)  #Showing line of optimal portfolio
points(sdP[ind],muP[ind],col="red",cex=4,pch="*") #The Tangent portfolio
ind2 = (sdP == min(sdP)) #The minimum sharpe ratio is the min variance port
points(sdP[ind2],muP[ind2],col="green",cex=2,pch="*") #Plotting the min variance 
ind3 = (muP > muP[ind2]) #All portfolios with in efficient frontier
lines(sdP[ind3],muP[ind3],type="l",xlim=c(0,0.25),
      ylim=c(0,0.3),col="red",lwd=3) #Efficient frontier 

#plotting all the single stoks
text(sd_vect[1],mean_vect[1],"Stock: GM")
text(sd_vect[2],mean_vect[2],"Stock: F")
text(sd_vect[3],mean_vect[3],"Stock: UTX")
text(sd_vect[4],mean_vect[4],"Stock: CAT")
text(sd_vect[5],mean_vect[5],"Stock: MRK")
text(sd_vect[6],mean_vect[6],"Stock: IBM")


#Problem 2



```
